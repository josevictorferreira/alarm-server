#!/usr/bin/env ruby
# frozen_string_literal: true

require 'bundler/setup'
require 'listen'
require_relative '../lib/alarm_server'

def start_server
  pid = fork do
    AlarmServer.run!
  end
  Process.detach(pid)
  pid
end

server_pid = start_server
puts("Alarm Server started with PID: #{server_pid}\n")

listener = Listen.to(File.expand_path('../lib', __dir__)) do |_modified, _added, _removed|
  puts("Changes detected in lib. Restarting Alarm Server...\n")

  begin
    Process.kill('TERM', server_pid)
    Process.wait(server_pid)
  end

  server_pid = start_server
  puts("Alarm Server restarted with PID: #{server_pid}\n")
end

listener.start

sleep
